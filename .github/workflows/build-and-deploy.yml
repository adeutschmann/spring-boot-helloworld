name: Build and Deploy to Nexus

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

permissions:
  contents: write
  packages: write

env:
  MAVEN_OPTS: '-Xmx1024m'
  REGISTRY: ${{ secrets.NEXUS_DOCKER_REGISTRY }}
  IMAGE_NAME: spring-boot-helloworld

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0

    - name: Extract Java version from pom.xml
      id: java-version
      run: |
        # Extract Java version from pom.xml properties
        JAVA_VERSION=$(grep -A 5 '<properties>' pom.xml | grep '<java.version>' | sed 's/.*<java.version>\(.*\)<\/java.version>.*/\1/' | xargs)
        echo "Extracted Java version: $JAVA_VERSION"
        echo "java-version=$JAVA_VERSION" >> $GITHUB_OUTPUT

    - name: Set up JDK ${{ steps.java-version.outputs.java-version }}
      uses: actions/setup-java@v4
      with:
        java-version: ${{ steps.java-version.outputs.java-version }}
        distribution: 'temurin'

    - name: Cache Maven dependencies
      uses: actions/cache@v4
      with:
        path: ~/.m2
        key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
        restore-keys: ${{ runner.os }}-m2

    - name: Run tests
      run: ./mvnw test

    - name: Build JAR
      run: ./mvnw clean package -DskipTests

    - name: Upload JAR artifact
      uses: actions/upload-artifact@v4
      with:
        name: spring-boot-helloworld-jar-${{ github.sha }}
        path: target/*.jar
        retention-days: 30

  build-container:
    runs-on: ubuntu-latest
    needs: build
    # Only build containers on merge to main/master (not on PRs)
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
    outputs:
      image-digest: ${{ steps.build.outputs.digest }}
      image-version: ${{ steps.version.outputs.release_version }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Download JAR artifact
        uses: actions/download-artifact@v4
        with:
          name: spring-boot-helloworld-jar-${{ github.sha }}
          path: target/

      - name: Extract and prepare version (same logic as deploy job)
        id: version
        run: |
          # Make Maven wrapper executable
          chmod +x ./mvnw
          
          # Extract current version using same logic as deploy job
          echo "Attempting to extract project information from pom.xml..."
          
          if CURRENT_VERSION=$(./mvnw help:evaluate -Dexpression=project.version -q -DforceStdout 2>/dev/null) && \
             GROUP_ID=$(./mvnw help:evaluate -Dexpression=project.groupId -q -DforceStdout 2>/dev/null) && \
             ARTIFACT_ID=$(./mvnw help:evaluate -Dexpression=project.artifactId -q -DforceStdout 2>/dev/null); then
            echo "‚úÖ Project info extracted using Maven wrapper:"
            echo "  GroupId: $GROUP_ID"
            echo "  ArtifactId: $ARTIFACT_ID" 
            echo "  Version: $CURRENT_VERSION"
          else
            echo "‚ö†Ô∏è Maven wrapper failed, trying alternative methods..."
          
            # Method 2: Parse pom.xml directly - extract project version specifically
            CURRENT_VERSION=$(grep -A 10 '<artifactId>helloworld</artifactId>' pom.xml | grep '<version>' | head -1 | sed 's/.*<version>\(.*\)<\/version>.*/\1/' | xargs)
            GROUP_ID=$(grep -A 5 '<artifactId>helloworld</artifactId>' pom.xml | grep -B 5 '<version>' | grep '<groupId>' | sed 's/.*<groupId>\(.*\)<\/groupId>.*/\1/' | xargs)
            ARTIFACT_ID=$(grep '<artifactId>helloworld</artifactId>' pom.xml | sed 's/.*<artifactId>\(.*\)<\/artifactId>.*/\1/' | xargs)
            echo "‚úÖ Project info extracted from pom.xml:"
            echo "  GroupId: $GROUP_ID"
            echo "  ArtifactId: $ARTIFACT_ID"
            echo "  Version: $CURRENT_VERSION"
          fi
          
          # Validate version format
          if [[ ! "$CURRENT_VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+(-SNAPSHOT)?$ ]]; then
            echo "‚ùå Invalid version format: $CURRENT_VERSION"
            echo "Setting default version: 0.0.1-SNAPSHOT"
            CURRENT_VERSION="0.0.1-SNAPSHOT"
          fi
          
          # Remove -SNAPSHOT suffix and extract version parts
          BASE_VERSION=$(echo $CURRENT_VERSION | sed 's/-SNAPSHOT//')
          echo "base_version=$BASE_VERSION" >> $GITHUB_OUTPUT

          # Extract major, minor, patch
          MAJOR=$(echo $BASE_VERSION | cut -d. -f1)
          MINOR=$(echo $BASE_VERSION | cut -d. -f2)
          PATCH=$(echo $BASE_VERSION | cut -d. -f3)

          # Increment patch version for release
          NEW_PATCH=$((PATCH + 1))
          RELEASE_VERSION="$MAJOR.$MINOR.$NEW_PATCH"

          echo "current_version=$CURRENT_VERSION" >> $GITHUB_OUTPUT
          echo "release_version=$RELEASE_VERSION" >> $GITHUB_OUTPUT

          echo "üìã Container Version Summary:"
          echo "  Current version: $CURRENT_VERSION"
          echo "  Release version (for container): $RELEASE_VERSION"

      - name: Set up Podman
        run: |
          sudo apt-get update
          sudo apt-get install -y podman

      - name: Update JAR to use release version for container build
        run: |
          # Rename the JAR file to use the release version (without SNAPSHOT)
          OLD_JAR=$(find target -name "*.jar" -not -name "*-sources.jar" -not -name "*-javadoc.jar" | head -1)
          if [[ -f "$OLD_JAR" ]]; then
            NEW_JAR="target/helloworld-${{ steps.version.outputs.release_version }}.jar"
            echo "Renaming JAR: $OLD_JAR -> $NEW_JAR"
            mv "$OLD_JAR" "$NEW_JAR"
            echo "‚úÖ JAR renamed to match release version"
          else
            echo "‚ùå Original JAR not found"
            exit 1
          fi

      - name: Build container image
        id: build
        run: |
          echo "üèóÔ∏è Building container image with release version ${{ steps.version.outputs.release_version }}..."
          
          # Build with podman using release version
          podman build -t local-build .
          
          echo "Container image built successfully"

      - name: Tag images for release
        env:
          REGISTRY: ${{ env.REGISTRY }}
          IMAGE_NAME: ${{ env.IMAGE_NAME }}
        run: |
          echo "üè∑Ô∏è Tagging images for release..."
          echo "Registry: $REGISTRY"
          echo "Image name: $IMAGE_NAME"
          echo "Release Version: ${{ steps.version.outputs.release_version }}"
          
          # Clean and validate registry URL
          if [ -n "$REGISTRY" ] && [ "$REGISTRY" != "" ]; then
            # Remove protocol prefixes if present
            CLEAN_REGISTRY=$(echo "$REGISTRY" | sed 's|^https\?://||' | sed 's|/$||')
            echo "Cleaned registry: $CLEAN_REGISTRY"
            
            # Validate registry format
            if [[ "$CLEAN_REGISTRY" =~ ^[a-zA-Z0-9.-]+:[0-9]+$ ]] || [[ "$CLEAN_REGISTRY" =~ ^[a-zA-Z0-9.-]+$ ]]; then
              echo "Tagging with registry: $CLEAN_REGISTRY"
              # Use release version (no SNAPSHOT) for container tags
              podman tag local-build $CLEAN_REGISTRY/$IMAGE_NAME:${{ steps.version.outputs.release_version }}
              podman tag local-build $CLEAN_REGISTRY/$IMAGE_NAME:latest
            else
              echo "‚ùå Invalid registry format: $CLEAN_REGISTRY"
              echo "Expected format: hostname:port or hostname"
              exit 1
            fi
          else
            echo "No registry configured, using local tags"
            # Use release version (no SNAPSHOT) for container tags
            podman tag local-build $IMAGE_NAME:${{ steps.version.outputs.release_version }}
            podman tag local-build $IMAGE_NAME:latest
          fi
          
          echo "Tagged images:"
          podman images | grep $IMAGE_NAME

      - name: Login to Nexus Docker Registry
        if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
        run: |
          echo "üîê Logging into Nexus Docker registry..."
          
          # Clean registry URL for login
          CLEAN_REGISTRY=$(echo "${{ env.REGISTRY }}" | sed 's|^https\?://||' | sed 's|/$||')
          echo "Login registry: $CLEAN_REGISTRY"
          
          echo "${{ secrets.NEXUS_PASSWORD }}" | podman login \
            --username "${{ secrets.NEXUS_USERNAME }}" \
            --password-stdin \
            $CLEAN_REGISTRY

      - name: Push container images
        if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
        run: |
          echo "üöÄ Pushing container images..."
          
          if [ -n "${{ env.REGISTRY }}" ]; then
            # Clean registry URL for pushing
            CLEAN_REGISTRY=$(echo "${{ env.REGISTRY }}" | sed 's|^https\?://||' | sed 's|/$||')
            echo "Push registry: $CLEAN_REGISTRY"
          
            # Push with release version (no SNAPSHOT)
            podman push $CLEAN_REGISTRY/${{ env.IMAGE_NAME }}:${{ steps.version.outputs.release_version }}
            podman push $CLEAN_REGISTRY/${{ env.IMAGE_NAME }}:latest
          
            echo "‚úÖ Images pushed successfully:"
            echo "  - $CLEAN_REGISTRY/${{ env.IMAGE_NAME }}:${{ steps.version.outputs.release_version }}"
            echo "  - $CLEAN_REGISTRY/${{ env.IMAGE_NAME }}:latest"
          else
            echo "‚ö†Ô∏è No registry configured, skipping push"
          fi

  deploy-to-nexus:
    runs-on: ubuntu-latest
    needs: build
    # Only deploy to Nexus on merge to main/master (not on PRs)
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0

    - name: Extract Java version from pom.xml
      id: java-version
      run: |
        # Extract Java version from pom.xml properties
        JAVA_VERSION=$(grep -A 5 '<properties>' pom.xml | grep '<java.version>' | sed 's/.*<java.version>\(.*\)<\/java.version>.*/\1/' | xargs)
        echo "Extracted Java version: $JAVA_VERSION"
        echo "java-version=$JAVA_VERSION" >> $GITHUB_OUTPUT

    - name: Set up JDK ${{ steps.java-version.outputs.java-version }}
      uses: actions/setup-java@v4
      with:
        java-version: ${{ steps.java-version.outputs.java-version }}
        distribution: 'temurin'

    - name: Cache Maven dependencies
      uses: actions/cache@v4
      with:
        path: ~/.m2
        key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
        restore-keys: ${{ runner.os }}-m2

    - name: Download JAR artifact
      uses: actions/download-artifact@v4
      with:
        name: spring-boot-helloworld-jar-${{ github.sha }}
        path: target/

    - name: Configure Maven settings for Nexus
      run: |
        mkdir -p ~/.m2
        
        cat > ~/.m2/settings.xml << EOF
        <?xml version="1.0" encoding="UTF-8"?>
        <settings xmlns="http://maven.apache.org/SETTINGS/1.0.0"
                  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                  xsi:schemaLocation="http://maven.apache.org/SETTINGS/1.0.0 
                                      http://maven.apache.org/xsd/settings-1.0.0.xsd">
          <servers>
            <server>
              <id>adeutschmanndev-nexus</id>
              <username>${{ secrets.NEXUS_USERNAME }}</username>
              <password>${{ secrets.NEXUS_PASSWORD }}</password>
            </server>
          </servers>
        </settings>
        EOF
        
        echo "‚úÖ Maven settings.xml configured successfully"

    - name: Extract current version
      id: version
      run: |
        # Make Maven wrapper executable
        chmod +x ./mvnw
        
        # Try multiple methods to extract version
        echo "Attempting to extract project information from pom.xml..."
        
        # Method 1: Try Maven wrapper for all project info
        if CURRENT_VERSION=$(./mvnw help:evaluate -Dexpression=project.version -q -DforceStdout 2>/dev/null) && \
           GROUP_ID=$(./mvnw help:evaluate -Dexpression=project.groupId -q -DforceStdout 2>/dev/null) && \
           ARTIFACT_ID=$(./mvnw help:evaluate -Dexpression=project.artifactId -q -DforceStdout 2>/dev/null); then
          echo "‚úÖ Project info extracted using Maven wrapper:"
          echo "  GroupId: $GROUP_ID"
          echo "  ArtifactId: $ARTIFACT_ID" 
          echo "  Version: $CURRENT_VERSION"
        else
          echo "‚ö†Ô∏è Maven wrapper failed, trying alternative methods..."
        
          # Method 2: Parse pom.xml directly - extract project version specifically
          CURRENT_VERSION=$(grep -A 10 '<artifactId>helloworld</artifactId>' pom.xml | grep '<version>' | head -1 | sed 's/.*<version>\(.*\)<\/version>.*/\1/' | xargs)
          GROUP_ID=$(grep -A 5 '<artifactId>helloworld</artifactId>' pom.xml | grep -B 5 '<version>' | grep '<groupId>' | sed 's/.*<groupId>\(.*\)<\/groupId>.*/\1/' | xargs)
          ARTIFACT_ID=$(grep '<artifactId>helloworld</artifactId>' pom.xml | sed 's/.*<artifactId>\(.*\)<\/artifactId>.*/\1/' | xargs)
          echo "‚úÖ Project info extracted from pom.xml:"
          echo "  GroupId: $GROUP_ID"
          echo "  ArtifactId: $ARTIFACT_ID"
          echo "  Version: $CURRENT_VERSION"
        fi
        
        # Validate extracted values
        if [[ -z "$GROUP_ID" || -z "$ARTIFACT_ID" ]]; then
          echo "‚ùå Failed to extract groupId or artifactId"
          exit 1
        fi
        
        # Validate version format
        if [[ ! "$CURRENT_VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+(-SNAPSHOT)?$ ]]; then
          echo "‚ùå Invalid version format: $CURRENT_VERSION"
          echo "Setting default version: 0.0.1-SNAPSHOT"
          CURRENT_VERSION="0.0.1-SNAPSHOT"
        fi
        
        # Set outputs
        echo "group_id=$GROUP_ID" >> $GITHUB_OUTPUT
        echo "artifact_id=$ARTIFACT_ID" >> $GITHUB_OUTPUT
        echo "current_version=$CURRENT_VERSION" >> $GITHUB_OUTPUT

        # Remove -SNAPSHOT suffix and extract version parts
        BASE_VERSION=$(echo $CURRENT_VERSION | sed 's/-SNAPSHOT//')
        echo "base_version=$BASE_VERSION" >> $GITHUB_OUTPUT

        # Extract major, minor, patch
        MAJOR=$(echo $BASE_VERSION | cut -d. -f1)
        MINOR=$(echo $BASE_VERSION | cut -d. -f2)
        PATCH=$(echo $BASE_VERSION | cut -d. -f3)

        # Increment patch version
        NEW_PATCH=$((PATCH + 1))
        RELEASE_VERSION="$MAJOR.$MINOR.$NEW_PATCH"
        NEXT_SNAPSHOT_VERSION="$MAJOR.$MINOR.$((NEW_PATCH + 1))-SNAPSHOT"

        echo "release_version=$RELEASE_VERSION" >> $GITHUB_OUTPUT
        echo "next_snapshot_version=$NEXT_SNAPSHOT_VERSION" >> $GITHUB_OUTPUT

        echo "üìã Project Summary:"
        echo "  GroupId: $GROUP_ID"
        echo "  ArtifactId: $ARTIFACT_ID"
        echo "  Current version: $CURRENT_VERSION"
        echo "  Release version: $RELEASE_VERSION"
        echo "  Next snapshot version: $NEXT_SNAPSHOT_VERSION"

    - name: Set release version
      run: |
        ./mvnw versions:set -DnewVersion=${{ steps.version.outputs.release_version }} -DgenerateBackupPoms=false
        echo "Set version to: ${{ steps.version.outputs.release_version }}"

    - name: Deploy release to Nexus
      run: |
        echo "üöÄ Deploying to Nexus repository..."
        echo "Project: ${{ steps.version.outputs.group_id }}:${{ steps.version.outputs.artifact_id }}:${{ steps.version.outputs.release_version }}"
        
        # Determine repository URL based on version type
        if [[ "${{ steps.version.outputs.release_version }}" == *"-SNAPSHOT" ]]; then
          REPO_URL="${{ secrets.NEXUS_URL }}/repository/maven-snapshots/"
          echo "üì¶ Deploying SNAPSHOT to: $REPO_URL"
        else
          REPO_URL="${{ secrets.NEXUS_URL }}/repository/maven-releases/"
          echo "üì¶ Deploying RELEASE to: $REPO_URL"
        fi
        
        # Find the actual JAR file that was built
        JAR_FILE=$(find target -name "${{ steps.version.outputs.artifact_id }}-*.jar" -not -name "*-sources.jar" -not -name "*-javadoc.jar" | head -1)
        
        if [[ ! -f "$JAR_FILE" ]]; then
          echo "‚ùå JAR file not found in target directory"
          echo "Looking for: target/${{ steps.version.outputs.artifact_id }}-*.jar"
          echo "Files in target directory:"
          ls -la target/
          exit 1
        fi
        
        echo "üì¶ Found JAR file: $JAR_FILE"
        
        # Deploy using Maven deploy plugin with the actual built JAR
        ./mvnw deploy:deploy-file \
          -DgroupId=${{ steps.version.outputs.group_id }} \
          -DartifactId=${{ steps.version.outputs.artifact_id }} \
          -Dversion=${{ steps.version.outputs.release_version }} \
          -Dpackaging=jar \
          -Dfile="$JAR_FILE" \
          -DrepositoryId=adeutschmanndev-nexus \
          -Durl=$REPO_URL \
          -DgeneratePom=false \
          -DpomFile=pom.xml
        
        echo "‚úÖ Successfully deployed ${{ steps.version.outputs.group_id }}:${{ steps.version.outputs.artifact_id }}:${{ steps.version.outputs.release_version }} to: $REPO_URL"

    - name: Create Git tag for release
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git tag -a "v${{ steps.version.outputs.release_version }}" -m "Release version ${{ steps.version.outputs.release_version }}"
        git push origin "v${{ steps.version.outputs.release_version }}"
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Update to next snapshot version
      run: |
        git checkout ${{ github.ref_name }}
        ./mvnw versions:set -DnewVersion=${{ steps.version.outputs.next_snapshot_version }} -DgenerateBackupPoms=false
        git add pom.xml
        git commit -m "chore: bump version to ${{ steps.version.outputs.next_snapshot_version }}"
        git push origin ${{ github.ref_name }}
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Upload deployment summary
      if: always()
      run: |
        echo "## Deployment Summary üöÄ" >> $GITHUB_STEP_SUMMARY
        echo "- **Branch**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Triggered by**: ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Released Version**: ${{ steps.version.outputs.release_version }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Next Development Version**: ${{ steps.version.outputs.next_snapshot_version }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Java Version**: ${{ steps.java-version.outputs.java-version }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Maven Build**: $(if [ ${{ job.status }} == 'success' ]; then echo '‚úÖ Success'; else echo '‚ùå Failed'; fi)" >> $GITHUB_STEP_SUMMARY
        echo "- **Nexus Deploy**: $(if [ ${{ job.status }} == 'success' ]; then echo '‚úÖ Deployed'; else echo '‚ùå Failed'; fi)" >> $GITHUB_STEP_SUMMARY
        echo "- **Git Tag**: v${{ steps.version.outputs.release_version }}" >> $GITHUB_STEP_SUMMARY
  update-dev-overlay:
    runs-on: ubuntu-latest
    needs: build-container        # ‚Üê your job that pushed the image
    if: needs.build-container.result == 'success'
    steps:
      - name: Checkout config repo
        uses: actions/checkout@v4
        with:
          repository: adeutschmann-dev/spring-boot-hello-world-gitops
          token: ${{ secrets.CONFIG_REPO_TOKEN }}   # PAT with repo write perms
          ref: main
          path: config-repo

      - name: Install yq
        run: sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/download/v4.44.3/yq_linux_amd64 && sudo chmod +x /usr/local/bin/yq

      - name: Update image tag in dev overlay
        env:
          TAG: ${{ needs.build-container.outputs.image-version || needs.build-container.outputs.tag || steps.version.outputs.release_version }}
        run: |
          cd config-repo/environments/dev
          yq -i '
            (.images[] | select(.name == "registry-nexus.apps.ocp4.adeutschmann.dev/spring-boot-helloworld")).newTag = env(TAG)
          ' kustomization.yaml

      - name: Commit & push
        run: |
          cd config-repo
          git config user.name "ci-bot"
          git config user.email "ci@example.com"
          git add environments/dev/kustomization.yaml
          git commit -m "Deploy dev: spring-boot-helloworld:${{ env.TAG }}"
          git push